import{GFX}from"./gfx.mjs";const keyCodeMap={KeyA:"a",KeyB:"b",KeyC:"c",KeyD:"d",KeyE:"e",KeyF:"f",KeyG:"g",KeyH:"h",KeyI:"i",KeyJ:"j",KeyK:"k",KeyL:"l",KeyM:"m",KeyN:"n",KeyO:"o",KeyP:"p",KeyQ:"q",KeyR:"r",KeyS:"s",KeyT:"t",KeyU:"u",KeyV:"v",KeyW:"w",KeyX:"x",KeyY:"y",KeyZ:"z",Digit1:"1",Digit2:"2",Digit3:"3",Digit4:"4",Digit5:"5",Digit6:"6",Digit7:"7",Digit8:"8",Digit9:"9",Digit0:"0",Space:"space",Tab:"tab",CapsLock:"caps",ShiftLeft:"lshift",ControlLeft:"lctrl",AltLeft:"lalt",MetaLeft:"lmeta",Comma:"comma",Period:"period",Slash:"slash",Backslash:"backslash",Semicolon:"semicolon",Quote:"quote",BracketLeft:"lbracket",BracketRight:"rbracket",Minus:"minus",Equal:"equal",Backspace:"backspace",Enter:"enter",ShiftRight:"rshift",ControlRight:"rctrl",AltRight:"ralt",ContextMenu:"menu",Escape:"esc",F1:"f1",F2:"f2",F3:"f3",F4:"f4",F5:"f5",F6:"f6",F7:"f7",F8:"f8",F9:"f9",F10:"f10",F11:"f11",F12:"f12",Delete:"del",End:"end",PageDown:"pgdn",Insert:"ins",Home:"home",PageUp:"pgup",PrintScreen:"prtsc",ScrollLock:"scrlk",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Numpad0:"num0",Numpad1:"num1",Numpad2:"num2",Numpad3:"num3",Numpad4:"num4",Numpad5:"num5",Numpad6:"num6",Numpad7:"num7",Numpad8:"num8",Numpad9:"num9",NumpadEnter:"numenter",NumpadAdd:"numplus",NumpadSubtract:"numminus",NumpadMultiply:"nummult",NumpadDivide:"numdiv",NumLock:"numlock",NumpadDecimal:"numdel",Pause:"pause",Backquote:"tilde"},mouseButtonMap=["lmb","mmb","rmb","mb3","mb4"];export class Game{constructor(e,t){const n=new GFX(e,t);this.gfx=n,this.eventListeners={},this.on=(e,t)=>(e in this.eventListeners||(this.eventListeners[e]=[]),this.eventListeners[e].push(t),this),this.off=(e,t)=>{if(e in this.eventListeners)return this.eventListeners[e]=this.eventListeners[e].filter((e=>e!==t)),this};const a=(e,...t)=>{if(e in this.eventListeners){for(const n of this.eventListeners[e])n(...t);return this}};this.emit=a;const s={get x(){return this.pos[0]},get y(){return this.pos[1]},pos:[0,0]};this.mouse=s;const i={};for(const e of Object.values(keyCodeMap))i[e]=!1;this.keys=i;let r=performance.now();const o=()=>{const e=performance.now();e-r!=0&&a("tick",e-r),r=e,requestAnimationFrame(o)};let u=!1;const c=Array(18).fill(!1);this.prevents=c;const l=e=>{i[e]=!0,a("keydown",e)},f=e=>{i[e]=!1,a("keyup",e)};window.addEventListener("keydown",(e=>{if(!e.repeat){const t=keyCodeMap[e.code];if(!t)return;l(t)}switch(e.code){case"Tab":c[0]&&e.preventDefault();break;case"F1":c[6]&&e.preventDefault();break;case"F2":c[7]&&e.preventDefault();break;case"F3":c[8]&&e.preventDefault();break;case"F4":c[9]&&e.preventDefault();break;case"F5":c[10]&&e.preventDefault();break;case"F6":c[11]&&e.preventDefault();break;case"F7":c[12]&&e.preventDefault();break;case"F8":c[13]&&e.preventDefault();break;case"F9":c[14]&&e.preventDefault();break;case"F10":c[15]&&e.preventDefault();break;case"F11":c[16]&&e.preventDefault();break;case"F12":c[17]&&e.preventDefault()}})),window.addEventListener("keyup",(e=>{const t=keyCodeMap[e.code];if(t)switch(f(t),e.code){case"AltLeft":c[1]&&e.preventDefault();break;case"AltRight":c[2]&&e.preventDefault()}})),window.addEventListener("mousedown",(e=>{const t=mouseButtonMap[e.button];t&&l(t)})),window.addEventListener("mouseup",(e=>{const t=mouseButtonMap[e.button];if(t)switch(f(t),e.button){case 3:c[3]&&e.preventDefault();break;case 4:c[4]&&e.preventDefault()}})),window.addEventListener("mousemove",(e=>{const t=n.canvas.getBoundingClientRect();this.mouse.pos=[(e.clientX-t.left)/t.width,(e.clientY-t.top)/t.height]})),window.addEventListener("contextmenu",(e=>{this.prevents[5]&&e.preventDefault()})),window.addEventListener("wheel",(e=>{0!=e.deltaY&&a("wheel",Math.sign(e.deltaY))}));const m=n.canvas.parentElement;this.fillParent=!1,new ResizeObserver((()=>{if(!this.fillParent)return;const e=m.getBoundingClientRect();if(n.width==e.width&&n.height==e.height)return;if(0==e.width||0==e.height)return;const t=[e.width,e.height];n.size=t,a("resize",t),u||(u=!0,o())})).observe(m)}get ratio(){return this.gfx.ratio}preventDefaultKeyBehaviours(e){const t=["tab","lalt","ralt","mb3","mb4","rmb","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"],n=e.all;for(let a=0;a<t.length;++a){const s=e[t[a]]??n;null!=s&&(this.prevents[a]=s)}return this}autoFillParent(e){return this.fillParent=e,this}canvasWork(e){this.localCanvas??=document.createElement("canvas");const t=this.localCanvas;return this.localCanvasCtx??=t.getContext("2d"),e(t,this.localCanvasCtx),this}async asset(e,t){switch(t??{txt:"string",bin:"buffer",wasm:"wasm",json:"json",png:"image",jpg:"image",jpeg:"image",bmp:"image"}[e.match(/(?<=\.)[a-zA-Z0-9_\-]+$/)?.[0]?.toLowerCase?.()]??"buffer"){case"string":return await(await fetch(e)).text();case"wasm":return(await WebAssembly.instantiate(await(await fetch(e)).arrayBuffer(),{})).instance.exports;case"json":return await(await fetch(e)).json();case"image":return await new Promise((t=>{const n=new Image;n.onload=()=>t(n),n.src=e}));default:return await(await fetch(e)).arrayBuffer()}}get time(){return performance.now()/1e3}}