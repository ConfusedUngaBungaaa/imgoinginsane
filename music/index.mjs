import{$download,$clamp}from"/util.mjs";const trackListEl=document.querySelector(".tracks"),tracksWrapper=document.querySelector(".tracks-wrapper"),tracksStagehand=document.querySelector(".tracks-stagehand"),playerVolumeEl=document.querySelector(".player-volume"),volumeSliderEl=document.querySelector(".player-volume-slider-wrapper"),playerEl=document.querySelector(".bottom-player"),body=document.querySelector("body"),playButton=document.querySelector(".player-button-play");(async()=>{const e=await(await fetch("track-pages/pages.json")).json(),t={};let i,n,l,r=!1,o=!0,a=null,c=[],s=[];function d(){a&&(a.volume=l)}let u=0;function v(){const e=u;if(a)if(isNaN(a.duration)){const t=()=>{a.currentTime=e*a.duration,a.removeEventListener("loadeddata",t)};a.addEventListener("loadeddata",t)}else a.currentTime=e*a.duration}const m=document.querySelector(".player-bar-progress");let y;function p(){if(null==n)return;playButton.children[0].style.visibility="hidden",playButton.children[1].style.visibility="visible",trackListEl.children[n].querySelector(".play-button").classList.add("playing");const e=Object.values(Object.values(t)[i])[n];e.audio_||(e.audio_=new Audio(`${e.dir}/${e.audio}`)),e.audio_.play(),e.audio_.volume=l,a?.removeEventListener("ended",g),a=e.audio_,a.addEventListener("ended",g)}function h(e){a&&(a.pause(),e&&(a.currentTime=0)),playButton.children[0].style.visibility="visible",playButton.children[1].style.visibility="hidden";for(const e of document.querySelectorAll(".play-button.playing"))e.classList.remove("playing")}function k(){for(const e of document.querySelectorAll(".track"))e.classList.remove("selected");trackListEl.children[n].classList.add("selected");for(const e of s)e()}function g(){o||h(!0),a&&(a.currentTime=0),n=(n+1)%trackListEl.children.length,o||p(),k()}setInterval((()=>{if(a&&(u=a.currentTime/a.duration,m.style=`width: ${~~(100*u*100)/100}%`),!isNaN(u)&&y!=u)for(const e of c)e();y=u}),1e3/60);{let L,S,q=!1,$=!1;function E(){volumeSliderEl.style="";const e=volumeSliderEl.getBoundingClientRect(),t=playerVolumeEl.getBoundingClientRect();volumeSliderEl.style.bottom=`${playerEl.getBoundingClientRect().height}px`,volumeSliderEl.style.left=t.left-e.width/2+t.width/2+"px"}const B=()=>{clearTimeout(S),q=!0,volumeSliderEl.classList.contains("visible")||volumeSliderEl.classList.add("visible"),E()},T=()=>{clearTimeout(S),$||(S=setTimeout((()=>{for(q=!1;volumeSliderEl.classList.contains("visible");)volumeSliderEl.classList.remove("visible")}),200))};playerVolumeEl.addEventListener("mouseenter",B),volumeSliderEl.addEventListener("mouseenter",B),playerVolumeEl.addEventListener("mouseleave",T),volumeSliderEl.addEventListener("mouseleave",T),playerVolumeEl.addEventListener("click",(()=>{0!=l?(0!=l&&(L=l,l=0,d()),b()):(L!=l&&(l=L,d()),b())})),new ResizeObserver(E).observe(body),l=localStorage.getItem("audio-volume"),l??=.5,addEventListener("beforeunload",(()=>{localStorage.setItem("audio-volume",l)})),d();const C=document.querySelector(".player-volume-slider"),R=document.querySelector(".player-volume-slider-progress");document.querySelector(".player-volume-slider-circle");function b(){for(const e of document.querySelectorAll(".player-volume-icon"))e.style.visibility="hidden";l>.5?playerVolumeEl.children[2].style.visibility="visible":l>0?playerVolumeEl.children[1].style.visibility="visible":playerVolumeEl.children[0].style.visibility="visible";volumeSliderEl.getBoundingClientRect(),R.getBoundingClientRect();const e=~~(100*l*100)/100;R.style=`height: ${e}%`}function f(e){if(!$)return;const t=C.getBoundingClientRect(),i=$clamp(1-(e.clientY-t.top)/t.height,0,1);i!=l&&(l=i,d()),b()}b(),volumeSliderEl.addEventListener("mousedown",(e=>{$=!0,f(e)})),addEventListener("mouseup",(e=>{f(e),$=!1,T()})),addEventListener("mousemove",(e=>{f(e)}))}playButton.addEventListener("click",(()=>{o=!o,o?h():p()}));document.querySelector(".player-button-next").addEventListener("click",(()=>g()));document.querySelector(".player-button-prev").addEventListener("click",(()=>(o||h(!0),a&&(a.currentTime=0),n=(n-1)%trackListEl.children.length,n<0&&(n+=trackListEl.children.length),o||p(),void k())));{let I=!1;const j=document.querySelector(".player-bar-wrapper"),N=document.querySelector(".player-bar"),O=document.querySelector(".player-bar-progress");function b(){O.style=`width: ${~~(100*u*100)/100}%`}function f(e){if(!I)return;const t=N.getBoundingClientRect(),i=$clamp((e.clientX-t.left)/t.width,0,1);i!=u&&(u=i,v()),b()}j.addEventListener("mousedown",(e=>{I=!0,f(e)})),addEventListener("mouseup",(e=>{I=!1})),addEventListener("mousemove",(e=>{f(e)}))}async function w(){const l=trackListEl.children.length;if(!(Math.ceil((tracksWrapper.scrollTop+tracksWrapper.getBoundingClientRect().height-27+1)/159)>l)||r)return;const d=trackListEl.appendChild(function(){const e=document.createElement("div");return e.innerHTML='<div class="track loading">\n            <div class="track-left">\n                <div class="track-image"></div>\n            </div>\n            <div class="track-right">\n                <div class="track-top">\n                    <div class="track-title">Forprix - I Love You</div>\n                    <div class="track-tags"></div>\n                </div>\n                <div class="track-wrapper">\n                    <div class="track-middle">\n                        <div class="play-button"></div>\n                        <div class="track-wave">\n                            <canvas class="track-wave-child"></canvas>\n                        </div>\n                    </div>\n                    <div class="track-bottom">\n                        <div class="track-bottom-button track-like-button"><div class="track-like-icon"></div>NICE</div>\n                        <div class="track-bottom-button track-dislike-button"><div class="track-dislike-icon"></div>BULLSHIT</div>\n                        <div class="track-bottom-button track-link-button"><div class="track-link-icon"></div>LINK</div>\n                        <div class="track-bottom-button track-download-button"><div class="track-download-icon"></div>DOWNLOAD</div>\n                    </div>\n                </div>\n            </div>\n        </div>',e.firstChild}());let y=trackListEl.children.length-1;const g=await async function(n){null==i&&(i=0);const l=e[i];t[l]||(t[l]=(async()=>{t[l]=Object.fromEntries((await(await fetch(`track-pages/${l}/tracks.json`)).json()).map((e=>[e,null])))})()),t[l]instanceof Promise&&await t[l];const o=t[l],a=Object.keys(o)[n];return null==a?void(r=!0):(o[a]||(o[a]=(async()=>{o[a]=await(await fetch(`track-pages/${l}/${a}/track.json`)).json(),o[a].dir=`track-pages/${l}/${a}`})()),o[a]instanceof Promise&&await o[a],o[a])}(trackListEl.children.length-1);if(!g)return d.remove();null==n&&(n=y,k());let E=0;const b=()=>{E++,2==E&&d.classList.remove("loading")},f=new Image;f.src=g.picture?`${g.dir}/${g.picture}`:"id.png";const L=new Image;L.src=`${g.dir}/${g.wave}`;{const B=d.querySelector(".track-wave-child"),T=B.getContext("2d");function S(e){if(!e&&n!=y)return;const t=C.getBoundingClientRect();B.width=t.width,B.height=t.height,T.fillStyle="white",T.fillRect(0,B.height/2,B.width,1),T.filter="contrast(0)",n==y&&a&&!isNaN(a.duration)?(T.drawImage(L,L.width*u,0,L.width,L.height,B.width*u,0,B.width,B.height),n==y&&(T.filter=`contrast(50%) brightness(300%) hue-rotate(${~~(performance.now()/3)}deg)`,T.drawImage(L,0,0,L.width*u,L.height,0,0,B.width*u,B.height))):T.drawImage(L,0,0,L.width,L.height,0,0,B.width,B.height)}c.push(S),s.push((()=>{S(!0)})),L.addEventListener("load",(()=>{S(!0)}));const C=d.querySelector(".track-wave");new ResizeObserver((()=>{S(!0)})).observe(C)}f.addEventListener("load",b),L.addEventListener("load",(()=>{b()})),d.querySelector(".track-image").style=`--track-image: url("${f.src}")`,d.querySelector(".track-title").innerText=g.name,d.querySelector(".play-button").addEventListener("click",(()=>{y==n?o?(o=!1,p()):(o=!0,h()):(o||(o=!0),h(!0),a&&(a.currentTime=0),n=y,o=!1,p(),k())}));const q=d.querySelector(".track-tags");for(const R of g.tags){const I=document.createElement("div");I.classList.add("track-tag"),I.innerText=`#${R.toUpperCase()}`,q.appendChild(I)}d.querySelector(".track-link-button").addEventListener("click",(()=>{open(`${g.dir}/${g.audio}`,"Track")})),d.querySelector(".track-download-button").addEventListener("click",(()=>{$download(`${g.dir}/${g.audio}`,g.name)}));{let j=!1;const N=d.querySelector(".track-wave");function $(e){if(!j)return;const t=N.getBoundingClientRect(),i=$clamp((e.clientX-t.left)/t.width,0,1);i!=u&&(u=i,v()),m.style=`width: ${~~(100*u*100)/100}%`}N.addEventListener("mousedown",(e=>{n!=y?(o||(o=!0),h(),a&&(a.currentTime=0),n=y,o=!1,p(),k()):o&&(o=!1,p()),j=!0,$(e)})),addEventListener("mouseup",(e=>{j=!1})),addEventListener("mousemove",(e=>{$(e)}))}w()}new ResizeObserver(w).observe(tracksWrapper),tracksWrapper.addEventListener("scroll",w),w()})();